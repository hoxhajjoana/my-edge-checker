import React, {useRef, useState } from "react";
import HeaderInput from "./HeaderInput";
import RequestTable from "./RequestTable";
import ResponseTable from "./ResponseTable";
import Modal from "./Modal";


function Form(props){

    let inputURL = useRef();
    let searchString = useRef();

    const [requestHeadersKeyArray, setRequestHeadersKeyArray ]= useState([]);
    const [requestHeadersValueArray,setRequestHeadersValueArray ]= useState([])
    const [responseHeadersKeyArray, setResponseHeadersKeyArray ]= useState([]);
    const [responseHeadersValueArray, setResponseHeadersValueArray ]= useState([]);

    const [requestContents, setRequestContents] = useState([]);
    const [responseContents, setResponseContents] = useState([]);

    const [requestChange, setRequestChange] = useState(0);
    const [responseChange, setResponseChange] = useState(0);
    
    const [sent, setSent] = useState(false)
    const [response, setResponse] =  useState(null)
    const [loading, setLoading] = useState(false)

    const [comError, setComError] = useState(false);
    const [notOk, setNotOk] = useState(false);
    const [inputNeeded, setInputNeeded] = useState(false);


    const handleInputURLChange = (event) => {
        inputURL.current.value = event.target.value;
        console.log(inputURL.current.value)
    }

    const handleSearchStringChange = (event) => {
        searchString.current.value = event.target.value;
        console.log(searchString.current.value)
    }

    const removeHeaderInput = (id, type) => {

        if(type==="Request"){

            const keyArray = requestHeadersKeyArray.slice(0);
            const valueArray = requestHeadersValueArray.slice(0);

            if(keyArray[id]){
                keyArray.splice(id, 1)
            }

            if(valueArray[id]){
                valueArray.splice(id, 1)
            }

            const content = requestContents.slice(0);
            
            content.splice(id, 1);
          
            
            setRequestHeadersKeyArray(keyArray);
            setRequestHeadersValueArray(valueArray);
            setRequestContents(content);
            debugger

        }
        else if(type==="Response"){

            const keyArray = responseHeadersKeyArray.slice(0);
            const valueArray = responseHeadersValueArray.slice(0);

            if(keyArray[id]){
                keyArray.splice(id, 1)
            }

            if(valueArray[id]){
                valueArray.splice(id, 1)
            }

            const content = responseContents.slice(0);
            
            console.log("response contents")
            console.log(responseContents)
            
            console.log("contents")
            console.log(content)
            
            content.splice(id, 1);

            setResponseHeadersKeyArray(keyArray);
            setResponseHeadersValueArray(valueArray);
            setResponseContents(content);

            debugger
        }

    }

    const getHeaderInput = (id, type, key, value, headerKeys, headerValues) => {

        let keyArray = headerKeys;
        let valueArray = headerValues;

        keyArray[id] = key;
        valueArray[id] = value;

        if(type==="Request"){
            
            setRequestHeadersKeyArray(keyArray);
            setRequestHeadersValueArray(valueArray);
        }
        else if(type==="Response"){
            
            setResponseHeadersKeyArray(keyArray);
            setResponseHeadersValueArray(valueArray);
        }
    }    

    async function handleSubmit(event){

        event.preventDefault();

        if(!inputURL.current.value){
            setInputNeeded(true);
            return false;
        }
        
        setResponse(null);

        const requestHeaders = {};
        const responseHeaders = {};

        console.log(responseHeadersKeyArray)
        console.log(responseHeadersValueArray)
        console.log(requestHeadersKeyArray)
        console.log(requestHeadersValueArray)

        for(let i = 0; i < responseHeadersKeyArray.length; i++){

            if(responseHeadersKeyArray[i]!==""){
                responseHeaders[responseHeadersKeyArray[i]] = responseHeadersValueArray[i];
            }
        }

        for(let i = 0; i < requestHeadersKeyArray.length; i++){

            if(requestHeadersKeyArray[i]!==""){
                requestHeaders[requestHeadersKeyArray[i]] = requestHeadersValueArray[i];
            }
        }

        const requestOptions = {
            method: 'POST',
            body: JSON.stringify({ 
                "url": inputURL.current.value,
                "ips": null,
                "searchStrings": [searchString.current.value],
                "requestHeaders": requestHeaders,
                "responseHeaders": responseHeaders
            })
        }

        setLoading(true);
        let a = await fetch('http://54.36.202.173:8080/edge-check', requestOptions).catch(err => {
            console.error(err)
            setComError(true);
            debugger
            return ("error")
        })
        setLoading(false);

        

        if(a !== "error"){
            if(a.ok){
                let jsonRespose = await a.json()
                console.log(jsonRespose)
                setResponse(jsonRespose)
            }
            else{
                setNotOk(true);
            }
        }

        setSent(true);

        return false;

    }  
    

    return(
        
        <>
        <form onSubmit={handleSubmit}> 

            <input placeholder="Input URL:" type="text" ref={inputURL} onChange={handleInputURLChange}/>

            <br/><br/>
            <div style={{display:"flex", justifyContent:"center", width:"100%"}}>

                <div style={{width:"50%"}}>
                    <label>
                        Request Headers 
                    </label>

                    <button type={"button"} onClick={
                        ()=>{
                            setRequestChange(requestChange+1);
                            setRequestContents([...requestContents, <HeaderInput type="Request" removeCallBack={removeHeaderInput} callBack={getHeaderInput}
                            headerKeys={requestHeadersKeyArray} headerValues={requestHeadersValueArray} key={requestChange} id={requestChange}/> ])
                            console.log(requestContents)
                            debugger
                        }
                    }>+</button>
                    <br/><br/>

                    {requestContents}
                    {console.log("requests")}
                    {console.log(requestContents)}
                </div>
                
                <div style={{width:"50%"}}>
                    <label>
                        Response Headers 
                    </label>

                    <button type={"button"} onClick={
                        ()=>{
                            setResponseChange(responseChange+1);
                            setResponseContents([...responseContents, <HeaderInput type="Response" content={responseContents} removeCallBack={removeHeaderInput} callBack={getHeaderInput} 
                            headerKeys={responseHeadersKeyArray} headerValues={responseHeadersValueArray} key={responseChange} id={responseChange}/>])
                            console.log(responseContents)
                            debugger                            
                        }

                    }>+</button>
                    <br/><br/> 
                    
                    {responseContents}
                    {console.log("response")}
                    {console.log(responseContents)}
                </div>
            </div>

            <input placeholder="Search String:" type="text" ref={searchString} onChange={handleSearchStringChange}/>

            <br/><br/>

            <input type="submit" value="Submit"/>        
            
        </form>

        <div>
            {/* TABLES */}

            {loading && "Loading..."}
            
            {sent && response && !comError && !notOk && <RequestTable url={response.url} responseHeaders={response.responseHeaders} searchString={response.searchString} requestHeaders={response.requestHeaders} errorMessages={response.errorMessages} />}

            {sent && response && !comError && !notOk && <ResponseTable response={response}/>}
            
        </div>

        <div>
            {/* MODALS */}

            {comError && <Modal text="Communication error. Please try again." close={() => {setComError(false)}}/>}

            {notOk && <Modal text="Not an error, but not okay either " close={() => {setNotOk(false)}}/>}

            {inputNeeded && <Modal text="You need to enter a URL before submitting" close={()=>{setInputNeeded(false)}}/>}
        </div>
    </>

    );
}

export default Form;