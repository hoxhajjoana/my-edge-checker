import React, {useRef, useState } from "react";
import HeaderInput from "./HeaderInput";


function Form(props){

    let inputURL = useRef();
    let searchString = useRef();

    //const [headerInputs, setHeaderInputs] = useState([]);

    const [requestContents, setRequestContents] = useState([]);
    const [responseContents, setResponseContents] = useState([]);

    const [requestChange, setRequestChange] = useState(0);
    const [responseChange, setResponseChange] = useState(0);


    const [response, setResponse] =  useState(null);

    const handleInputURLChange = (event) => {
        inputURL.current.value = event.target.value;
        console.log(inputURL.current.value)
    }

    const handleSearchStringChange = (event) => {
        searchString.current.value = event.target.value;
        console.log(searchString.current.value)
    }

    const requestHeaders = [];
    const responseHeaders = [];

    const getHeaderInput = (id, type, key, value) => {
        if(type==="Request"){
            requestHeaders[id] = [key, value];
        }
        else if(type==="Response"){
            responseHeaders[id] = [key, value];
        }
    }    

    async function handleSubmit(){

        const requestOptions = {
            method: 'POST',
            body: JSON.stringify({ 
                "url": inputURL.current.value,
                "ips": null,
                "searchStrings": [searchString.current.value],
                "requestHeaders": requestHeaders,
                "responseHeaders": responseHeaders
            })
        }
    
        let a = await fetch('http://54.36.202.173:8080/edge-check', requestOptions).catch(err => {
            alert("Communication Error. Please try again")
            console.error(err)
            return ("error")
        })

        console.log(a)

        if(a !== "error"){
            if(a.ok){
                let jsonRespose = await a.json()
                setResponse(jsonRespose)
            }
            else{
                let e = await a.text();
                alert(e)
            }
        }
        console.log("response")
        console.log(response)
        //setSent(true)

    }  
    

    return(
        
        <form onSubmit={handleSubmit}> 

            <label>
                Input URL:
                <input type="text" ref={inputURL} onChange={handleInputURLChange}/>
            </label>

            <br/><br/>

            <button type={"button"} onClick={
                ()=>{
                    setRequestChange(requestChange+1);
                    setRequestContents([...requestContents, <HeaderInput type="Request" callBack={getHeaderInput} key={requestChange} id={requestChange}/>])
                }
            }>Add Request Header</button>
            <br/><br/>
            {requestContents}

            <button type={"button"} onClick={
                ()=>{
                    setResponseChange(responseChange+1);
                    setResponseContents([...responseContents, <HeaderInput type="Response" callBack={getHeaderInput} key={responseChange} id={responseChange}/>])
                }

            }>Add Response Header</button>
            <br/><br/> 
            {responseContents}

            <label>
                Search String:
                <input type="text" ref={searchString} onChange={handleSearchStringChange}/>
            </label>

            <br/><br/>

            <input type="submit" value="Submit"/>        
            
        </form>
    );
}

export default Form;